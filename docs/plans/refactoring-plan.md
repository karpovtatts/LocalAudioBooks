# План рефакторинга: Упрощение UI/UX (удаление Car Mode) и внедрение статистики

## 1. Резюме и Цели (Executive Summary)

Главная цель данного плана — радикальное упрощение приложения для повышения удобства использования (с учетом особенностей восприятия при СДВГ) и устранение лишнего функционала. Мы удаляем "Автомобильный режим", фокусируемся на идеальном UI/UX основного плеера и добавляем систему статистики для геймификации процесса прослушивания.

### Ключевые цели:

1. **Удаление Car Mode**: Полная очистка кодовой базы от неиспользуемого режима вождения.
2. **UX/UI "Best Practices"**: Редизайн основного плеера и библиотеки для максимальной ясности, чистоты и предсказуемости интерфейса (решение проблемы "непонятно, где управление").
3. **Статистика**: Внедрение модуля сбора и отображения статистики прослушивания (время, количество книг).
4. **Стабильность PWA**: Обеспечение надежной работы офлайн и сохранения прогресса.

---

## 2. Анализ текущей ситуации

На данный момент проект содержит архитектурное разделение на обычный плеер и Car Mode.

### Проблемы:

- **Проблема UX**: Пользователь путается при добавлении книги (интерфейс не дает четкой обратной связи).
- **Лишний код**: `CarModeScreen.tsx`, логика переключения в Settings, дублирование управления воспроизведением.
- **Архитектура**: Модульная структура (ui, player, storage) позволяет безболезненно удалить Car Mode и расширить модуль Storage для статистики.

---

## 3. Предлагаемое решение / Стратегия рефакторинга

### 3.1. Высокоуровневый дизайн (High-Level Design)

Архитектура остается SPA (Single Page Application), но навигация упрощается.

#### Новая схема навигации:

```
Библиотека (Главная)
    ├─→ Клик по книге → Плеер (Единый экран)
    └─→ Кнопка настроек → Настройки / Статистика

Плеер
    └─→ Кнопка назад → Библиотека

Настройки / Статистика
    └─→ Кнопка назад → Библиотека
```

#### Принципы UI для СДВГ:

- **Минимализм**: На экране только то, что нужно прямо сейчас.
- **Четкая обратная связь**: При добавлении папки — явное уведомление или анимация появления книг.
- **Крупные элементы**: Даже без Car Mode, кнопки управления должны быть большими и удобными.

### 3.2. Ключевые компоненты / Модули

#### UI Module (Refactor):

- **Удаление**: `CarModeScreen`
- **Объединение**: Лучшие черты Car Mode (крупные кнопки, свайпы) в `PlayerScreen`. Плеер должен быть один, но очень удобный.
- **Добавление**: Экран `StatisticsScreen`

#### Storage Module (Update):

- **Удаление**: Настройки Car Mode
- **Добавление**: Хранилище для статистики (`stats`)

#### App Logic (Refactor):

- **Упрощение**: Роутинг в `App.tsx`

### 3.3. Детальный план действий / Этапы

#### Этап 1: Очистка (Cleanup)

**Цель**: Удалить мертвый код и зависимости, связанные с Car Mode.

**Приоритет**: Высокий

**Задачи**:

1. **Задача 1.1**: Удалить файл `src/ui/screens/CarModeScreen.tsx` и его тесты `src/ui/screens/__tests__/CarModeScreen.test.tsx`
2. **Задача 1.2**: Удалить спецификацию `docs/feats/car-mode-ui.md`
3. **Задача 1.3**: Очистить `src/storage/index.ts` (удалить `carModeEnabled` из интерфейса `Settings` и дефолтных настроек)
4. **Задача 1.4**: Очистить `src/ui/screens/SettingsScreen.tsx` от переключателя режима
5. **Задача 1.5**: Обновить `src/App.tsx` и `src/ui/AppContext.tsx`, убрав логику условного рендеринга Car Mode

**Критерии готовности**:
- ✅ Код компилируется без ошибок
- ✅ Отсутствуют упоминания CarMode в коде
- ✅ Все тесты проходят

---

#### Этап 2: Редизайн Плеера и Библиотеки (Core UX)

**Цель**: Сделать интерфейс интуитивным, решить проблему "не появляется интерфейс".

**Приоритет**: Высокий

**Задачи**:

1. **Задача 2.1**: Рефакторинг `PlayerScreen.tsx`
   - **Goal**: Сделать кнопки Play/Pause и перемотки крупными и контрастными (взять стилистику из удаленного Car Mode, но в более элегантном виде)
   - **Feature**: Добавить поддержку свайпов (влево/вправо) для перемотки в этот единственный плеер (это удобно всегда, не только в машине)

2. **Задача 2.2**: Улучшение UX при добавлении книг в `LibraryScreen.tsx`
   - **Goal**: При завершении сканирования папки, если добавлена только одна книга — автоматически открывать её? Или показывать всплывающее уведомление (Toast) "Добавлено N книг"
   - **Fix**: Добавить индикацию пустой библиотеки с огромной кнопкой "Добавить первую книгу"

3. **Задача 2.3**: Визуализация прогресса
   - **Goal**: Убедиться, что на карточке книги в библиотеке ярко виден прогресс (например, зеленая полоса), чтобы пользователь сразу видел, что он слушает сейчас

**Критерии готовности**:
- ✅ При добавлении книги пользователь сразу понимает, что она добавилась (визуальный фидбек)
- ✅ Плеер поддерживает управление одной рукой (крупные кнопки)
- ✅ Свайпы работают для перемотки

---

#### Этап 3: Реализация Статистики (New Feature)

**Цель**: Геймификация и отчетность.

**Приоритет**: Средний

**Задачи**:

1. **Задача 3.1**: Расширение схемы БД (`src/storage/index.ts`)
   - Создать store `statistics`
   - Структура: `{ date: string (YYYY-MM-DD), duration: number (seconds), bookId: string }`

2. **Задача 3.2**: Логика сбора данных в `src/player/index.ts`
   - При воспроизведении накапливать секунды и периодически (или при паузе) сохранять их в статистику

3. **Задача 3.3**: Создание UI `StatisticsScreen.tsx`
   - Отображение: "Всего прослушано за год", "Любимые книги" (по времени)
   - Добавить кнопку перехода к статистике из Настроек или Библиотеки

**Критерии готовности**:
- ✅ В разделе статистики отображается корректное время прослушивания после сессии
- ✅ Статистика сохраняется локально в IndexedDB
- ✅ UI статистики доступен из настроек

---

#### Этап 4: PWA и Полировка

**Приоритет**: Низкий

**Задачи**:

1. **Задача 4.1**: Проверка манифеста и иконок (убедиться, что приложение выглядит как нативное)
2. **Задача 4.2**: Проверка сохранения позиции при закрытии вкладки (уже реализовано, но требует регрессионного тестирования после изменений)

**Критерии готовности**:
- ✅ PWA работает офлайн
- ✅ Позиция воспроизведения сохраняется при закрытии

---

### 3.4. Изменения в модели данных

#### Изменения в Settings:

```typescript
// Удалить
carModeEnabled: boolean;
```

#### Новая сущность DailyStats (в IndexedDB):

```typescript
interface DailyStats {
  date: string; // Primary Key "YYYY-MM-DD"
  totalSeconds: number;
  booksListened: string[]; // Массив ID книг, которые слушали в этот день
}
```

### 3.5. Дизайн API (Внутренний)

#### Новые методы в `src/storage/index.ts`:

- `saveDailyStats(seconds: number, bookId: string): Promise<void>` — добавляет время к текущему дню
- `getYearlyStats(year: number): Promise<{ totalSeconds: number, booksCount: number }>` — агрегация данных

---

## 4. Ключевые соображения и риски

### 4.1. Технические риски

1. **Миграция настроек**: При удалении поля `carModeEnabled` старые сохраненные настройки пользователей могут вызвать ошибку при парсинге, если типизация строгая.
   - **Mitigation**: В функции `loadSettings` добавить проверку и очистку устаревших полей.

2. **Производительность записи статистики**: Слишком частая запись в IDB (каждую секунду) может нагружать диск.
   - **Mitigation**: Агрегировать время в памяти и сбрасывать в БД раз в 30-60 секунд или при событии `pause`/`beforeunload`.

### 4.2. Нефункциональные требования (NFRs)

- **Удобство (Accessibility/Usability)**: Интерфейс должен быть "Calm Tech" — не перегружать внимание. Использование системных шрифтов, темной темы по умолчанию (или авто).
- **Надежность**: Позиция воспроизведения — это святое. Она не должна теряться никогда.

---

## 5. Метрики успеха

1. ✅ Код компилируется без ошибок, отсутствуют упоминания CarMode
2. ✅ При добавлении книги пользователь сразу понимает, что она добавилась (визуальный фидбек)
3. ✅ Плеер поддерживает управление одной рукой (крупные кнопки)
4. ✅ В разделе статистики отображается корректное время прослушивания после сессии

---

## 6. Допущения

1. Мы полагаем, что пользователь использует современные браузеры (Chrome/Safari на мобильных), поддерживающие IndexedDB и PWA.
2. Статистика хранится только локально (нет синхронизации между устройствами), так как бэкенд отсутствует.

---

## 7. Открытые вопросы

**Вопрос**: Нужно ли реализовывать "Историю прослушивания" (список конкретных книг с датами) или достаточно агрегированных цифр (часы)?

**Решение**: Для MVP (Minimum Viable Product) достаточно агрегированных цифр "Часов за год" и "Книг за год".

---

## 8. Порядок выполнения этапов

Этапы выполняются последовательно:

1. **Этап 1** → Очистка (удаление Car Mode)
2. **Этап 2** → Редизайн UI/UX (плеер и библиотека)
3. **Этап 3** → Реализация статистики
4. **Этап 4** → PWA и полировка

---

## 9. Критерии готовности каждого этапа

1. ✅ Все задачи этапа выполнены
2. ✅ Все тесты проходят
3. ✅ Код соответствует TypeScript и ESLint правилам
4. ✅ Нет регрессий в существующем функционале

---

**Дата создания плана**: 2026-01-02  
**Версия**: 1.0  
**Статус**: Готов к выполнению

