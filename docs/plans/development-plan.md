# План разработки проекта LocalAudioBooks

Этот документ описывает поэтапный план разработки приложения LocalAudioBooks согласно спецификации.

## Общая стратегия

Проект разрабатывается по **spec-driven методологии**:
- Код генерируется только из спеки (read.txt)
- Тесты генерируются из Gherkin-сценариев (feats/*.md)
- Ручное редактирование кода запрещено
- Все изменения начинаются с обновления спеки

## Этапы разработки

### Этап 0: Подготовка инфраструктуры (Foundation)

**Цель**: Создать базовую структуру проекта, настроить инструменты разработки и среды тестирования.

#### Задачи:
1. **Инициализация проекта**
   - Создать структуру папок модулей (common, ui, player, library, storage, utils)
   - Настроить package.json с зависимостями
   - Настроить TypeScript конфигурацию
   - Настроить ESLint, Prettier

2. **Настройка сборки**
   - Настроить Webpack/Vite для сборки PWA
   - Настроить обработку TypeScript
   - Настроить Tailwind CSS

3. **Настройка тестирования**
   - Установить и настроить Jest
   - Установить и настроить Cypress
   - Создать структуру папок для тестов

4. **PWA инфраструктура**
   - Создать базовый manifest.json
   - Настроить Service Worker с Workbox
   - Настроить базовые оффлайн-страницы

**Результат**: Готовая инфраструктура для разработки, сборки и тестирования.

---

### Этап 1: Модуль Storage (JEP-2 часть)

**Цель**: Реализовать локальное хранение данных (прогресс, настройки, папки).

#### Задачи:
1. **Инфраструктура IndexedDB**
   - Создать обёртку для работы с IndexedDB
   - Определить схемы БД для книг, прогресса, настроек
   - Реализовать миграции БД

2. **API модуля storage**
   - `saveProgress(bookId, position)` — сохранение позиции
   - `loadProgress(bookId)` — загрузка позиции
   - `saveSettings(settings)` — сохранение настроек
   - `loadSettings()` — загрузка настроек
   - `saveSelectedFolders(folders)` — сохранение выбранных папок
   - `loadSelectedFolders()` — загрузка выбранных папок

3. **Настройки по умолчанию**
   - preferredSkipInterval: 30
   - carModeEnabled: false
   - playbackSpeed: 1.0
   - selectedFolders: []

**Тесты**: Unit-тесты для всех методов storage API.

**Результат**: Полностью функциональный модуль storage с сохранением и загрузкой данных.

---

### Этап 2: Модуль Utils

**Цель**: Реализовать общие утилиты (парсеры, обработка ошибок).

#### Задачи:
1. **Утилиты для обработки файлов**
   - Функция для определения типа аудиофайла (MP3, M4A, WAV, AAC, OGG)
   - Функция для нормализации путей
   - Функция для проверки дубликатов

2. **Обработка ошибок**
   - Централизованная система ошибок
   - Типизированные классы ошибок

3. **Утилиты для работы со временем**
   - Форматирование времени (mm:ss, hh:mm:ss)
   - Конвертация секунд в читаемый формат

**Тесты**: Unit-тесты для всех утилит.

**Результат**: Набор переиспользуемых утилит.

---

### Этап 3: Модуль Library (JEP-2, JEP-5) — Feat: library.md

**Цель**: Реализовать сканирование папок, парсинг метаданных и управление библиотекой.

#### Задачи:
1. **Интеграция с File System Access API**
   - Запрос доступа к папке
   - Рекурсивное сканирование директорий
   - Фильтрация аудиофайлов (приоритет MP3)

2. **Парсинг метаданных (JEP-5)**
   - Интеграция music-metadata-browser
   - Извлечение: название, автор, обложка, главы
   - Обработка отсутствующих метаданных (fallback на имя файла)

3. **Управление библиотекой**
   - Добавление книг без дубликатов
   - Хранение информации о книгах в IndexedDB (через storage)
   - Обновление библиотеки при повторном сканировании

4. **API модуля library**
   - `scanFolder(folderHandle)` — сканирование папки
   - `getAllBooks()` — получение всех книг
   - `getBook(bookId)` — получение конкретной книги
   - `removeBook(bookId)` — удаление книги

**Тесты**: 
- Unit-тесты для парсинга метаданных
- Integration-тесты для сканирования папок
- E2E-тесты для сценариев из feats/library.md

**Результат**: Рабочая библиотека с возможностью добавления папок и отображения книг.

---

### Этап 4: Модуль Player (JEP-1, JEP-6 часть) — Feat: playback-basic.md, playback-skip.md

**Цель**: Реализовать логику воспроизведения аудио с базовыми функциями и перемоткой.

#### Задачи:
1. **Интеграция Howler.js (JEP-1)**
   - Инициализация движка воспроизведения
   - Поддержка форматов: MP3, M4A, WAV, AAC, OGG
   - Обработка ошибок загрузки

2. **Базовое воспроизведение (feats/playback-basic.md)**
   - Play/Pause
   - Управление громкостью
   - Изменение скорости (0.5×–2.0×)
   - Автосохранение позиции (интеграция с storage)

3. **Перемотка на интервалы (feats/playback-skip.md, JEP-6)**
   - Перемотка назад на 15/30/60 сек
   - Перемотка вперёд на 15/30/60 сек
   - Выбор предпочтительного интервала (из настроек)
   - Ограничение позиции (минимум 0, максимум длительность)

4. **API модуля player**
   - `loadBook(bookId)` — загрузка книги для воспроизведения
   - `play()` / `pause()` / `togglePlayPause()`
   - `seek(position)` — установка позиции
   - `skipBackward(seconds)` / `skipForward(seconds)`
   - `setSpeed(speed)` — установка скорости
   - `setVolume(volume)` — установка громкости
   - `getCurrentPosition()` — текущая позиция
   - `getDuration()` — длительность трека

**Тесты**:
- Unit-тесты для всех методов player API
- Integration-тесты с mock-аудио
- E2E-тесты для сценариев из feats/playback-basic.md и feats/playback-skip.md

**Результат**: Полностью функциональный плеер с базовым воспроизведением и перемоткой.

---

### Этап 5: Модуль UI — Базовый интерфейс (JEP-4)

**Цель**: Создать базовый пользовательский интерфейс с библиотекой и обычным плеером.

#### Задачи:
1. **Настройка React + Tailwind CSS (JEP-4)**
   - Настроить Tailwind CSS
   - Создать базовые компоненты (Button, Card, Input)
   - Настроить светлую/тёмную тему (системные настройки)

2. **Управление состоянием**
   - Настроить React Context для глобального состояния
   - Состояния: текущая книга, прогресс, настройки, библиотека

3. **Экран библиотеки (feats/library.md)**
   - Список/сетка карточек книг
   - Отображение обложки (или плейсхолдера)
   - Название, автор, прогресс прослушивания
   - Кнопка "Добавить папку"
   - Поиск и фильтрация (feats/search.md)

4. **Экран обычного плеера**
   - Большая центральная кнопка Play/Pause
   - Кнопки перемотки (←15, ←30, ←60, 15→, 30→, 60→)
   - Индикатор выбора интервала перемотки
   - Ползунок прогресса с временем
   - Управление скоростью и громкостью
   - Название книги и автор
   - Кнопка "Назад в библиотеку"

5. **Экран настроек**
   - Переключатель Car Mode
   - Выбор предпочтительного интервала перемотки
   - Управление скоростью по умолчанию
   - Список выбранных папок

**Тесты**:
- Unit-тесты для React компонентов
- E2E-тесты для всех UI-сценариев

**Результат**: Полнофункциональный UI с библиотекой, плеером и настройками.

---

### Этап 6: Модуль UI — Car Mode (JEP-6) — Feat: car-mode-ui.md

**Цель**: Реализовать упрощённый интерфейс для использования в автомобиле.

#### Задачи:
1. **Car Mode UI (feats/car-mode-ui.md)**
   - Огромная центральная кнопка Play/Pause (25–30% высоты экрана)
   - Два ряда больших кнопок перемотки (←15, ←30, ←60, 15→, 30→, 60→)
   - Крупный текст: название книги и автор сверху
   - Крупные цифры: текущая позиция и общая длительность
   - Крупная кнопка "Назад в библиотеку" (левый верхний угол)
   - Все кнопки: минимум 80×80 dp (рекомендуется 100+ dp)
   - Высокий контраст для читаемости

2. **Жесты (feats/car-mode-ui.md)**
   - Свайп вправо → перемотка назад на текущий интервал
   - Свайп влево → перемотка вперёд на текущий интервал
   - Интеграция с библиотекой жестов (react-swipeable или аналог)

3. **Вибрация при нажатии**
   - Использование Vibration API для тактильной обратной связи

4. **Переключение режимов**
   - Плавный переход между обычным и Car Mode
   - Сохранение состояния в настройках

**Тесты**:
- Unit-тесты для Car Mode компонентов
- E2E-тесты для жестов и вибрации
- Тесты на размеры touch-target

**Результат**: Полностью функциональный Car Mode с крупными кнопками и жестами.

---

### Этап 7: Feat: progress.md

**Цель**: Реализовать сохранение и восстановление прогресса прослушивания.

#### Задачи:
1. **Автосохранение прогресса**
   - Периодическое сохранение позиции во время воспроизведения (каждые 5–10 секунд)
   - Сохранение при паузе/остановке
   - Сохранение при закрытии приложения

2. **Восстановление прогресса**
   - Загрузка позиции при открытии книги
   - Автоматический переход к последней позиции

3. **Отображение прогресса в библиотеке**
   - Процент прослушанного на карточках книг
   - Визуальный индикатор прогресса

**Тесты**: E2E-тесты для сценариев из feats/progress.md.

**Результат**: Полностью автоматическое сохранение и восстановление прогресса.

---

### Этап 8: PWA доработка (JEP-3)

**Цель**: Доработать PWA для полной оффлайн-работы и установки.

#### Задачи:
1. **Service Worker оптимизация**
   - Кэширование статических ресурсов
   - Стратегии кэширования для аудиофайлов
   - Оффлайн-страница с информацией

2. **Manifest.json**
   - Иконки для всех платформ (Android, iOS, Windows)
   - Правильные размеры иконок
   - Настройка отображения (standalone, fullscreen)

3. **Оффлайн-функциональность**
   - Работа без интернета
   - Индикация оффлайн-режима

4. **Установка PWA**
   - Тестирование установки на разных платформах
   - Инструкции для пользователей

**Тесты**: E2E-тесты оффлайн-режима.

**Результат**: Полностью функциональное PWA, работающее оффлайн.

---

### Этап 9: Финализация и оптимизация

**Цель**: Оптимизация, исправление багов, подготовка к релизу.

#### Задачи:
1. **Оптимизация производительности**
   - Оптимизация рендеринга React компонентов
   - Ленивая загрузка компонентов
   - Оптимизация работы с IndexedDB

2. **Обработка ошибок**
   - Улучшенная обработка ошибок файловой системы
   - Обработка отсутствия поддержки File System Access API
   - Fallback для старых браузеров

3. **Тестирование**
   - Запуск всех тестов (Jest + Cypress)
   - Исправление падающих тестов
   - Достижение покрытия тестами >80%

4. **Документация**
   - README.md с инструкциями по установке
   - LICENSE.md с указанием некоммерческого использования
   - Инструкции для пользователей

5. **Полировка UI/UX**
   - Улучшение анимаций и переходов
   - Проверка доступности (a11y)
   - Тестирование на реальных устройствах

**Результат**: Готовое к релизу приложение.

---

## Порядок выполнения этапов

Этапы выполняются последовательно, так как каждый этап зависит от предыдущих:
- **Этап 0** → инфраструктура
- **Этап 1** → storage (нужен для всех остальных)
- **Этап 2** → utils (нужен для других модулей)
- **Этап 3** → library (нужен для UI)
- **Этап 4** → player (нужен для UI)
- **Этап 5** → базовый UI (использует library и player)
- **Этап 6** → Car Mode UI (расширение базового UI)
- **Этап 7** → progress (интеграция всех модулей)
- **Этап 8** → PWA доработка
- **Этап 9** → финализация

## Критерии готовности каждого этапа

1. ✅ Все задачи этапа выполнены
2. ✅ Все тесты проходят
3. ✅ Код соответствует TypeScript и ESLint правилам
4. ✅ Обновлён wal.md с информацией о прогрессе
5. ✅ Обновлена спецификация при необходимости

## Примечания

- При обнаружении несоответствий между кодом и спеку — обновляется спека, затем перегенерируется код
- Тесты генерируются из Gherkin-сценариев в feats/*.md
- Все изменения в архитектуре сначала отражаются в спеки (read.txt)

---

**Дата создания плана**: 2026-01-02  
**Версия спеки**: из read.txt (последнее обновление)

