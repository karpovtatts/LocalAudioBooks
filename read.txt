# Полная обновлённая спецификация проекта LocalAudioBooks  
(на русском языке, единым документом для копирования)

Этот документ — полный актуальный источник истины (спека) проекта LocalAudioBooks на момент последнего обновления. Проект полностью разрабатывается с помощью ИИ по spec-driven подходу. Код генерируется только из этой спеки, в него не заглядывают и не редактируют вручную. Тесты также генерируются исключительно из спеки.

Весь проект структурирован вокруг корневого модуля **common**. Все остальные модули — его подмодули. Описание на русском языке.

## Бутлоадер проекта (main.md)

Проект LocalAudioBooks создаётся полностью ИИ с использованием spec-driven методологии. Эта спека — единственный источник истины. При любых изменениях обновляем спеку и перегенерируем код/тесты. Ручное редактирование кода запрещено.

Краткое описание приложения  
LocalAudioBooks — кросс-платформенное офлайн-приложение для прослушивания аудиокниг с локальных файлов устройства. Основной упор на формат MP3, поддерживаются также M4A, WAV, AAC, OGG. Нет магазина, покупок и стриминга — только файлы пользователя. Пользователь указывает папки с книгами, приложение сканирует их, извлекает метаданные, организует библиотеку, воспроизводит аудио и запоминает прогресс.

Платформы: Android, iOS, Windows.  
Реализация: Progressive Web App (PWA) для установки через браузер и работы на всех указанных платформах.

Целевая аудитория: люди, которые экономят и предпочитают локальные файлы (бесплатные книги, свои коллекции). Основной сценарий использования — прослушивание в автомобиле.

Юридические особенности: только личное некоммерческое использование. Запрещено любое коммерческое применение, продажа или монетизация. Файл LICENSE.md должен явно это указывать.

Безопасность: минимальная, данные нечувствительные, всё локально.

## Структура проекта (structure.md)

Корневой модуль: **common** (описывает всё приложение как единое целое).

Подмодули:
- **ui** — весь пользовательский интерфейс (библиотека, плеер обычный и Car Mode, настройки).
- **player** — логика воспроизведения аудио, перемотка, скорость, громкость.
- **library** — сканирование папок, парсинг метаданных, управление библиотекой.
- **storage** — локальное сохранение прогресса, настроек, предпочтений пользователя (IndexedDB).
- **utils** — общие утилиты (парсеры, обработка ошибок).

Связи:
- library → ui и player (поставляет данные о книгах).
- player → storage (сохраняет позицию).
- ui → все остальные (координирует взаимодействие).

Нет внешне управляемых директорий.

## Архитектура и технологии

Архитектура: клиентская одностраничная (SPA), offline-first, полностью в браузере.  
Паттерны: адаптация MVC под веб + реактивное управление состоянием.

Технологии:
- Язык: TypeScript (предпочтительно) / JavaScript.
- Фреймворк UI: React.js с хуками.
- Аудио: Howler.js или Web Audio API.
- Управление состоянием: React Context + hooks (или Redux при необходимости).
- Доступ к файлам: File System Access API (выбор папок).
- Метаданные: music-metadata-browser.
- PWA: Workbox (Service Worker для оффлайн и кэширования).
- Стили: Tailwind CSS (для быстрого создания больших кнопок и responsive-дизайна).
- Тестирование: Jest (unit/integration), Cypress (e2e).
- Дизайн: современный, responsive (mobile-first), светлая/тёмная тема по системным настройкам, высокий контраст.

## Функциональность (Feats)

### feats/library.md
```
Функция: Управление библиотекой аудиокниг

Сценарий: Добавление папки с книгами
  Дано пользователь открыл приложение
  Когда нажимает «Добавить папку» и выбирает директорию
  Тогда приложение сканирует её и вложенные папки на аудиофайлы (приоритет MP3)
  И извлекает метаданные (название, автор, обложка, главы)
  И добавляет книги в библиотеку без дубликатов

Сценарий: Отображение библиотеки
  Дано в библиотеке есть книги
  Тогда отображаются карточки с обложкой (или плейсхолдером), названием, автором и прогрессом прослушивания
```

### feats/playback-basic.md
```
Функция: Базовое воспроизведение

Сценарий: Запуск и пауза
  Дано открыта книга на экране плеера
  Когда пользователь нажимает большую центральную кнопку Play/Pause
  Тогда воспроизведение начинается или приостанавливается

Сценарий: Изменение скорости и громкости
  Дано активно воспроизведение
  Когда пользователь меняет скорость (0.5×–2.0×) или громкость
  Тогда изменения применяются сразу и сохраняются
```

### feats/playback-skip.md (новая)
```
Функция: Перемотка на фиксированные интервалы (15/30/60 сек)

Сценарий: Перемотка назад
  Дано воспроизведение или пауза
  Когда пользователь нажимает кнопку ←15, ←30 или ←60 сек
  Тогда позиция уменьшается ровно на выбранное количество секунд (минимум 0)

Сценарий: Перемотка вперёд
  Дано воспроизведение или пауза
  Когда пользователь нажимает кнопку 15→, 30→ или 60→ сек
  Тогда позиция увеличивается ровно на выбранное количество секунд (максимум конец трека)

Сценарий: Выбор предпочтительного интервала
  Дано пользователь на экране плеера
  Когда нажимает на индикатор текущего интервала (например, «30 сек»)
  Тогда появляется выбор 15 / 30 / 60 сек
  И выбранный интервал сохраняется как настройка пользователя (по умолчанию 30 сек)
```

### feats/car-mode-ui.md (новая, ключевая для автомобиля)
```
Функция: Режим управления в автомобиле (Car Mode)

Сценарий: Включение режима
  Дано пользователь в настройках или на главном экране
  Когда включает переключатель «Режим вождения» (Car Mode)
  Тогда интерфейс плеера переключается в упрощённый автомобильный режим

Сценарий: Экран плеера в Car Mode
  Дано включён Car Mode
  Тогда экран содержит только самые необходимые крупные элементы:
    • Огромная центральная кнопка Play/Pause (не менее 25–30% высоты экрана)
    • Два ряда больших кнопок перемотки:
        – ряд назад: ←15 сек   ←30 сек   ←60 сек
        – ряд вперёд: 15 сек→   30 сек→   60 сек→
    • Крупный текст: название книги и автор сверху
    • Крупные цифры текущей позиции и общей длительности
    • Крупная кнопка «Назад в библиотеку» в левом верхнем углу
  И все кнопки имеют размер touch-target минимум 80×80 dp (рекомендуется 100+ dp), высокий контраст, вибрацию при нажатии

Сценарий: Жесты в Car Mode
  Дано включён Car Mode
  Когда пользователь свайпает вправо по экрану → перемотка назад на текущий интервал
  Когда пользователь свайпает влево по экрану → перемотка вперёд на текущий интервал
```

### feats/progress.md
```
Функция: Сохранение прогресса

Сценарий: Автосохранение и возобновление
  Дано пользователь слушал книгу и вышел
  Когда снова открывает эту книгу
  Тогда воспроизведение начинается с последней позиции
  И в библиотеке отображается процент прослушанного
```

### feats/search.md
```
Функция: Поиск и фильтрация

Сценарий: Поиск по названию или автору
  Дано в библиотеке несколько книг
  Когда пользователь вводит текст в поиск
  Тогда отображаются только подходящие книги
```

## Предложения (Props) — ключевые JEP

**JEP-1**: Движок воспроизведения аудио (Howler.js, поддержка MP3 и других форматов).  
**JEP-2**: Интеграция с файловой системой (File System Access API).  
**JEP-3**: Реализация PWA (manifest.json + Service Worker).  
**JEP-4**: Дизайн и темизация (Tailwind CSS, светлая/тёмная тема).  
**JEP-5**: Обработка метаданных (music-metadata-browser).  
**JEP-6**: Фиксированная перемотка (15/30/60 сек) и Car Mode интерфейс для управления в автомобиле одной рукой (большие кнопки, жесты, вибрация).

## Система непрерывного обновления

- Папка **plans/** — детальные планы по этапам.
- Файл **wal.md** — лог с разделами «Прошлое», «Настоящее», «Будущее», «Вектор развития». Обновляется после каждого значимого шага.
- Обновление планов и спеки: через мета-анализ ИИ с утверждением человеком.

## Тесты

Генерируются только из раздела Feats (Gherkin-сценарии). Ожидается несколько тысяч тестов. Код постепенно доводится до прохождения всех.

## Настройки, которые должны сохраняться (в storage)

- preferredSkipInterval: 15 | 30 | 60 (по умолчанию 30)
- carModeEnabled: boolean (по умолчанию false, но легко включается)
- playbackSpeed: число (по умолчанию 1.0)
- selectedFolders: массив handles папок

Готово. Это полный актуальный документ-спека проекта LocalAudioBooks.  

Теперь можно переходить к следующему шагу: генерация тестов, структуры проекта, кода компонентов или макетов экранов Car Mode.  
Скажи, что делать дальше!